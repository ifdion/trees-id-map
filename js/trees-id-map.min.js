"use strict";function isElement(a){return"object"==typeof HTMLElement?a instanceof HTMLElement:a&&"object"==typeof a&&null!==a&&1===a.nodeType&&"string"==typeof a.nodeName}function archiveMap(a,b,c,d){var e=document.getElementById(a),f="http://api.trees.id/?object=lot&per_page="+lotPerPage+"&callback=callback",g=e.getAttribute("data-lot-page");if(!b)var b=[],c=[];if(!d)var d=1;f=f+"&page="+d,archiveParameter.forEach(function(a){var b=e.getAttribute("data-"+a);b&&(f=f+"&"+a+"="+b)}),1==d&&e.insertAdjacentHTML("beforebegin",'<div id="trees-id-map-progress"><div id="trees-id-map-progress-bar" style="width:0%;"></div>'),_jsonp.send(f,{onSuccess:function(e){e.data.forEach(function(a){if(a.kordinat_center){var d=parseFloat(a.kordinat_center.lat),e=parseFloat(a.kordinat_center.lng);b.push([d,e,a.id_lot]),mapCenter[0]+=d,mapCenter[1]+=e}c[a.id_lot]=a});var f=Math.ceil(e.totalCount/lotPerPage),h=document.getElementById("trees-id-map-progress-bar"),i=b.length/e.totalCount*100;if(h.style.width=i+"%",console.log(i.toFixed(2)+" % "),1==d){var j=_.map(mapCenter,function(a){return a/b.length});window.map=new L.Map("trees-id-map",{center:j,zoom:initialZoom,layers:[Esri_WorldImagery]}),window.map.scrollWheelZoom.disable(),window.heat=L.heatLayer(b,heatmapSetting).addTo(window.map)}else window.heat.setLatLngs(b);f>1&&f>d?(d++,archiveMap(a,b,c,d)):(h.style.height=0,window.map.fitBounds(b)),window.map.on("zoomend dragend",function(){var a=window.map.getZoom();if(a>=polygonBreakPoint){var d=window.map.getBounds(),e=d.getWest(),f=d.getSouth(),h=d.getEast(),i=d.getNorth(),j=_.filter(b,function(a){return a[1]>e-.005&&a[1]<h+.005&&a[0]<i+.005&&a[0]>f-.005});j.length>0&&j.forEach(function(a){if(-1===lastLot.indexOf(a)){lastLot.push(a);var b=g.replace("[lot]",c[a[2]].id_lot),d='<a class="popup-link text-center" href="'+b+'"><img id="popup-image" class="popup-image" src="'+c[a[2]].img_lot+'" width="200" ></div><br> <span>'+c[a[2]].nama_lot+"</span></a>";activeLot[a[2]]=L.polygon(c[a[2]].kordinat,{color:lotPolygonColor,weight:lotPolygonWeight,fillColor:lotPolygonFillColor,fillOpacity:lotPolygonFillOpacity}).bindPopup(d),activeLot[a[2]].addTo(window.map)}});var k=_.difference(lastLot,j);k.forEach(function(a){var b=lastLot.indexOf(a);lastLot.splice(b,1),window.map.removeLayer(activeLot[a[2]])}),window.map.removeLayer(window.heat)}else window.heat.addTo(window.map),activeLot.forEach(function(a){window.map.removeLayer(a)}),lastLot=[]})},onTimeout:function(){console.log("timeout!")}})}function singleMap(a){var b=document.getElementById(a),c=b.getAttribute("data-tree-page"),d=b.getAttribute("data-id"),e="http://api.trees.id/?object=lot&callback=callback&content=map&id="+d;_jsonp.send(e,{onSuccess:function(a){if(void 0!==a.data){window.map=new L.Map("trees-id-map",{center:a.mapCenter,zoom:polygonBreakPoint,layers:[Esri_WorldImagery]}),window.map.scrollWheelZoom.disable();var e=b.getAttribute("data-offset");if(e){var f=e.split(","),g=[];f.forEach(function(b){var e=[a.data[b][0],a.data[b][1]];g.push(e);var f=c.replace("[lot]",d).replace("[offset]",b),h='<a href="'+f+'"><img src="'+baseURL+a.id_relawan+"/"+d+"/"+a.data[b][2]+'" width="200"></a>';activeTree[parseInt(b)]=L.marker([a.data[b][0],a.data[b][1]],{icon:treeIcon}).addTo(window.map).bindPopup(h)}),window.map.fitBounds(g),activeTree.slice(-1)[0].openPopup()}else window.heat=L.heatLayer(a.data,heatmapSetting).addTo(window.map),window.map.fitBounds(a.data),window.map.on("zoomend dragend",function(){var b=window.map.getZoom();if(b>=markerBreakPoint){var e=window.map.getBounds(),f=e.getWest(),g=e.getSouth(),h=e.getEast(),i=e.getNorth(),j=_.filter(a.data,function(a){return a[1]>f-5e-5&&a[1]<h+5e-5&&a[0]<i+5e-5&&a[0]>g-5e-5});j.length>0&&j.forEach(function(b){if(-1===lastTree.indexOf(b)){lastTree.push(b);var e=c.replace("[lot]",d).replace("[offset]",parseInt(b[2])),f='<a href="'+e+'"><img src="'+baseURL+a.id_relawan+"/"+d+"/"+b[2]+'" width="200"></a>';activeTree[b[2]]=L.marker([b[0],b[1]],{icon:treeIcon}).addTo(window.map).bindPopup(f)}});var k=_.difference(lastTree,j);k.forEach(function(a){var b=lastTree.indexOf(a);lastTree.splice(b,1),window.map.removeLayer(activeTree[a[2]])}),window.map.removeLayer(window.heat)}else window.heat.addTo(window.map),lastTree.forEach(function(a){window.map.removeLayer(activeTree[a[2]])}),lastTree=[]})}else{var h=[];a.polygon.forEach(function(a){var b=L.latLng(a[0],a[1]);h.push(b)}),window.map=new L.Map("trees-id-map",{center:a.center,zoom:polygonBreakPoint,layers:[Esri_WorldImagery]}),window.map.scrollWheelZoom.disable(),window.lotPolygon=L.polygon(h,{color:lotPolygonColor,weight:lotPolygonWeight,fillColor:lotPolygonFillColor,fillOpacity:lotPolygonFillOpacity}),window.lotPolygon.addTo(window.map)}},onTimeout:function(){console.log("timeout!")}})}function treeMap(a){var b=document.getElementById(a),c=b.getAttribute("data-id");if(void 0!=c)var d="http://api.trees.id/?object=tree&callback=callback&single_id="+c;else var e=b.getAttribute("data-lot_id"),f=b.getAttribute("data-offset"),d="http://api.trees.id/?object=tree&callback=callback&lot_id="+e+"&tree_offset="+f;_jsonp.send(d,{onSuccess:function(a){window.map=new L.Map("trees-id-map",{center:a.data[0].tree_kordinat,zoom:markerBreakPoint,layers:[Esri_WorldImagery]}),window.map.scrollWheelZoom.disable(),a.data.forEach(function(a,b){console.log(a,b);{var c='<img src="'+a.img_tree+'" width="200">';L.marker(a.tree_kordinat,{icon:treeIcon}).addTo(window.map).bindPopup(c).openPopup()}})},onTimeout:function(){console.log("timeout!")}})}var lotCoordinate=[],lotData=[],mapCenter=[0,0],lastLot=[],lastTree=[],activeLot=[],activeTree=[],lotPerPage=20,polygonBreakPoint=17,initialZoom=7,markerBreakPoint=22,heatmapSetting={radius:10,blur:10,maxZoom:11,gradient:{.4:"lime",.65:"green",1:"darkgreen"}},baseURL="http://api.trees.id/tree/",archiveParameter=["program_id","project_id","block_id","relawan_id","verifikator_id","petani_id","status"],lotPolygonColor="lime",lotPolygonWeight=2,lotPolygonFillColor="darkgreen",lotPolygonFillOpacity=.5,treeIcon=L.icon({iconUrl:"http://api.trees.id/tree.png",iconSize:[16,16],iconAnchor:[0,8],popupAnchor:[8,-8]}),Esri_WorldImagery=L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community",maxZoom:27,maxNativeZoom:17}),_jsonp=function(){var a={};return a.send=function(a,b){var c=b.callbackName||"callback",d=b.onSuccess||function(){},e=b.onTimeout||function(){},f=b.timeout||20,g=window.setTimeout(function(){window[c]=function(){},e()},1e3*f);window[c]=function(a){window.clearTimeout(g),d(a)};var h=document.createElement("script");h.type="text/javascript",h.async=!0,h.src=a,document.getElementsByTagName("head")[0].appendChild(h)},a}();